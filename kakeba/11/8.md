Redis 的字符串表示  

```c
struct sdshdr{
    int len; // 记录sds保存字符串的长度  
    int free; // 记录buf数组中未使用字节的数量  
    char buf[]; // 字节数据，用于保存字符串  
}
```

3.2 之后根据不同的字符串长度，定义了很多的 sds 结构体  
主要区别在于 len 和 free 的类型不同  
- sdshdr5 字符串长度小于 1\<\<5=32 字节  
- sdshdr8 字符串长度小于 1\<\<8=256 字节
- sdshdr16 字符串长度小于 1\<\<16 字节
- sdshdr32 字符串长度小于 1\<\<32 字节
- sdshdr64 字符串长度小于 1\<\<64 字节

sds 与c字符串的比较  
- 获取字符串长度：sds O(1) C字符串是 O(n)  
- 缓冲区溢出：sds 由于记录了长度，在可能造成缓冲区溢出时会自动重新分配内存，杜绝了溢出  
- 修改字符串时内存的重分配：C字符串修改时必须重新分配内存（先释放再申请），如果没有重新分配，字符串长度增大时会造成缓冲区溢出，字符串减小则造成内存泄漏。而sds由于记录了字符串长度，可以进行优化，如空间预分配策略、惰性空间释放策略  
- 存取二进制数据：C字符串不可以，sds可以。因为c字符串以空字符作为结束标识，而sds以长度作为结束标识（同时也使用了\0结尾以确保可以使用C字符串库中的部分函数）  

[back](../11.md)  