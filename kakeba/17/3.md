zookeeper 中的”过半“指的是超过集群中设定的节点数量的一半  
原先有 6 台服务器，大于 3 为过半。当这个集群只剩下 3 台服务器时，集群无法继续运行。最多能接受 2 台节点宕机，容灾能力为 2  
如果原先有 5 台服务器，大于 2 视为过半。当集群只剩下 2 台服务器时，集群无法继续运行。最多能接受 2 台节点宕机，容灾能力为 2  
可见使用 6 台和 5 台服务器，容灾能力相同，所以建议使用奇数个服务器。只不过使用 6 台服务器吞吐量一定高于 5 台。  

---

容灾设计方案  
三机房部署：每个机房的主机数量必须少于集群总数的一半，这样任意一个机房断电都能够继续提供服务  
两机房部署：任一机房断电都无法继续提供服务，和单机房差不多，所以不推荐  

---  

脑裂问题  
- Leader 机房和另一机房之间断网，不会出现脑裂  
断网机房无法选举成功，因为正常的机房处于 Following 状态不接受投票   
- Leader 机房和另外两台机房直接断网，会出现短暂的脑裂，导致读数据不一致  
Leader 可以提供短暂的读服务，写服务因无法投票成功失败；其余两台机房可以重新选举出 Leader 提供服务  
原 Leader 会发现超过半数的节点失去连接，于是自动退位进入 Looking 状态  
- 三台机房全部断网，不会出现脑裂，只有 Leader 机房会提供短暂的服务，当 Leader 自动退位后整个服务不可用  

[back](../17.md)  